name: "vdbench"

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  
jobs:
  vdbench:
    strategy:
      fail-fast: false
      matrix:
        meta: [ 'sqlite3', 'redis', 'mysql', 'tikv', 'tidb', 'postgres', 'mariadb', 'badger', 'fdb']
    runs-on: ubuntu-latest

    steps:        
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Set Variable
        id: vars
        run: |
          if [ "${{matrix.meta}}" == "fdb" ]; then
            echo ::set-output name=target::"juicefs.fdb"
          else
            echo ::set-output name=target::"juicefs"
          fi

      - name: Build
        uses: ./.github/actions/build
        with: 
          target: ${{steps.vars.outputs.target}}    

      - name: Prepare meta db
        run: | 
          chmod +x .github/scripts/start_meta_engine.sh
          source .github/scripts/start_meta_engine.sh
          start_meta_engine ${{matrix.meta}}
          meta_url=$(get_meta_url ${{matrix.meta}})
          create_database $meta_url

      - name: Install tools
        shell: bash
        run: |
          wget -q https://dl.minio.io/client/mc/release/linux-amd64/mc
          chmod +x mc 
          wget -q https://s.juicefs.com/static/bench/vdbench50407.zip
          unzip vdbench50407.zip -d vdbench
          
      - name: Start minio
        run: |
          docker run -d -p 9000:9000 --name minio \
                      -e "MINIO_ACCESS_KEY=minioadmin" \
                      -e "MINIO_SECRET_KEY=minioadmin" \
                      -v /tmp/data:/data \
                      -v /tmp/config:/root/.minio \
                      minio/minio server /data
        
      - name: vdbench-big 
        shell: bash
        run: | 
          source .github/scripts/start_meta_engine.sh
          meta_url=$(get_meta_url ${{matrix.meta}})
          ./juicefs format $meta_url vdbench-big
          ./juicefs mount -d $meta_url /tmp/jfs
          vdbench/vdbench -f ./.github/workflows/resources/vdbench_big_file.conf

      - uses: actions/upload-artifact@v3
        with:
          name: output-big
          path: output

      - name: Clean
        shell: bash
        run: |
          source .github/scripts/start_meta_engine.sh
          meta_url=$(get_meta_url ${{matrix.meta}})
          rm /var/jfsCache/ -rf || true
          if [ -d /tmp/jfs }} ]; then
            ./juicefs umount /tmp/jfs || true
          fi
          uuid=$(./juicefs status $meta_url | grep UUID | cut -d '"' -f 4) || true
          if [ -n "$uuid" ];then
            sudo ./juicefs destroy --force $meta_url $uuid
          fi

      - name: vdbench-small
        shell: bash
        run: |
          source .github/scripts/start_meta_engine.sh
          meta_url=$(get_meta_url ${{matrix.meta}})
          ./juicefs format $meta_url vdbench-small
          ./juicefs mount -d $meta_url /tmp/jfs       
          vdbench/vdbench -f ./.github/workflows/resources/vdbench_small_file.conf

      - uses: actions/upload-artifact@v3
        with:
          name: output-small
          path: output

      - name: log
        if: ${{ always() }}
        shell: bash
        run: | 
          tail -300 ~/.juicefs/juicefs.log
          grep "<FATAL>:" ~/.juicefs/juicefs.log && exit 1 || true
          
      - name: Send Slack Notification
        if: ${{ failure() }}
        uses: juicedata/slack-notify-action@main
        with:
          channel-id: "${{ secrets.SLACK_CHANNEL_ID_FOR_PR_CHECK_NOTIFY }}"
          slack_bot_token: "${{ secrets.SLACK_BOT_TOKEN }}"          

